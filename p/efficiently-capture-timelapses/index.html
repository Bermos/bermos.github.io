<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="How to reduce storage space used while capturing timelapses over long durations."><title>Efficiently capture timelapses</title><link rel=canonical href=https://bermos.github.io/p/efficiently-capture-timelapses/><link rel=stylesheet href=/scss/style.min.1b3ac667198cb83edcc9c45e606a6f4dd6910b8ada6b74d7fd988f1b2dfd0c7c.css><meta property="og:title" content="Efficiently capture timelapses"><meta property="og:description" content="How to reduce storage space used while capturing timelapses over long durations."><meta property="og:url" content="https://bermos.github.io/p/efficiently-capture-timelapses/"><meta property="og:site_name" content="Bermos tech and thoughts"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="timelapse"><meta property="article:tag" content="photo"><meta property="article:tag" content="video"><meta property="article:tag" content="storage"><meta property="article:tag" content="ffmpeg"><meta property="article:published_time" content="2022-05-03T00:00:00+00:00"><meta property="article:modified_time" content="2022-05-03T00:00:00+00:00"><meta name=twitter:title content="Efficiently capture timelapses"><meta name=twitter:description content="How to reduce storage space used while capturing timelapses over long durations."><script defer data-domain=bermos.github.io src=https://plausible.io/js/plausible.js></script></head><body class="article-page has-toc"><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex
extended"><div id=article-toolbar><a href=/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg><span>Back</span></a></div><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/general-knowledge/>General Knowledge</a></header><h2 class=article-title><a href=/p/efficiently-capture-timelapses/>Efficiently capture timelapses</a></h2><h3 class=article-subtitle>How to reduce storage space used while capturing timelapses over long durations.</h3><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>May 03, 2022</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>4 minute read</time></div></footer></div></header><section class=article-content><h1 id=efficiently-capture-timelapses>Efficiently capture timelapses</h1><h2 id=the-problem>The problem</h2><p>You want to capture a timelapse over the course of lets say a week.
For reference, I&rsquo;m going to use the defaults given by the RaspberryPi camera module.
If any kind of detail of movement should be captured the length between taking single pictures cannot be too great.
For active scenes with people moving about a picture once every minute won&rsquo;t cut it.
One every 5 seconds is from my personal testing about right to capture human scale movement.</p><p>Pictures taken by the RaspberryPi camera module are about 5 MP in size, in .jpeg that comes out to about 2.4MB per picture <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.
For a week of timelapsing that&rsquo;s a whooping <code>2.4 * 12 * 60 * 24 * 7 = 290304MB = 283.5GB</code>! Even with SD card prices
dropping as they have it is still a rather costly endeavour.</p><h2 id=the-idea>The idea</h2><p>Now most timelapses have a rather neat property. Most of the time, most of the picture won&rsquo;t change from frame to frame.
This means a lot of the data is redundant! It would therefore make sense if we could only store the <em>usually</em> small
difference between each frame.</p><h2 id=the-a-solution>The (a) solution</h2><p>The video codec H.264 and it&rsquo;s newer iteration H.265 do exactly that. They create keyframes which are full pictures and
every subsequent frame is calculated by its difference to its predecessor. Which also means H.26x only has to store
keyframes + the changes in each frame. A test with the less efficient codec H.264 resulted in about 64GB of storage
used for 120 continuous days of taking one picture every 5 seconds. Of course the exact storage consumption will vary
depending on how much each picture differs from the next.</p><h2 id=examples>Examples</h2><p>Sounds cool and whatnot, how do I actually encode a video on the fly?
The answer as with all things AV is of course <a class=link href=https://www.ffmpeg.org/ target=_blank rel=noopener>ffmpeg</a>.</p><p><code>ffmpeg -f image2pipe -framerate 25 -i - -c:v libx264 -f mp4 -r 25 output.mp4</code></p><p>Let me explain what this command is about.</p><ul><li><code>-f image2pipe</code>: force input to be the image2pipe format</li><li><code>-framerate 25</code>: this is purely personal, if you want your timelapse to have 60fps set it here</li><li><code>-i -</code>: get the image from the pipe <code>-</code>, this will be useful shortly</li><li><code>-c:v libx264</code>: use the H.264 codec</li><li><code>-f mp4</code>: force output to be in the mp4 format</li><li><code>-r 25</code>: force the output video framerate to 25fps</li><li><code>output.mp4</code>: output file name</li></ul><p>So to recap this command instructs ffmpeg to take images from the pipe and
encode them into the output.mp4 file as long as the pipe is open.
You can use named pipes to keep this command open and pipe the images into it when they are taken.</p><h2 id=it-cant-be-that-easy-can-it>It can&rsquo;t be that easy, can it?</h2><p>Of course not. Your Raspberry might crash, lose power, or you accidentally stop the image
taking or the ffmpeg process. If that happens you&rsquo;ll find that your video is corrupted.
It can be rescued if you are lucky, but I wouldn&rsquo;t count on it.</p><p><code>ffmpeg -f image2pipe -framerate 25 -i - -g 120 -c:v libx264 -f mp4 -movflags frag_keyframe+empty_moov -r 25 args.out_name</code></p><p>So what does this extended ffmpeg command do?</p><ul><li><code>-g 120</code>: sets the interval between keyframes to 120. So at max 119 frames can be lost. Decreasing the number minimises the loss but increases the file size.</li><li><code>-movflags frag_keyframe+empty_moov</code>: this moves the movie encoding information to the beginning of the file. Normally this would be written at the end when
the ffmpeg process is terminated gracefully.</li></ul><p>These modifications can confuse some lesser video players so after recording is finished it
is recommended to re-encode the video with this <code>ffmpeg -i input.mp4 -c copy output.mp4</code> easy
command.</p><h2 id=the-code>The code</h2><p>So, after many words what was actually done with the knowledge gained?</p><p>I wrote a Python script that would let us capture the LAN party we organized with our student
association from setting up the first table to cleaning the last RedBull can.</p><p>Code: <a class=link href=https://github.com/VSETH-GECO/PiCam target=_blank rel=noopener>Raspberry PI timelapse recoder</a></p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>&ldquo;Raspberry Pi Documentation - Camera&rdquo;, <a class=link href=https://www.raspberrypi.com/documentation/accessories/camera.html#file-size target=_blank rel=noopener>https://www.raspberrypi.com/documentation/accessories/camera.html#file-size</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></section><footer class=article-footer><section class=article-tags><a href=/tags/timelapse/>timelapse</a>
<a href=/tags/photo/>photo</a>
<a href=/tags/video/>video</a>
<a href=/tags/storage/>storage</a>
<a href=/tags/ffmpeg/>ffmpeg</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-contents--wrapper></aside><footer class=site-footer><section class=copyright>&copy;
2022 -
2023 Bermos tech and thoughts</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.7.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#the-problem>The problem</a></li><li><a href=#the-idea>The idea</a></li><li><a href=#the-a-solution>The (a) solution</a></li><li><a href=#examples>Examples</a></li><li><a href=#it-cant-be-that-easy-can-it>It can&rsquo;t be that easy, can it?</a></li><li><a href=#the-code>The code</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>